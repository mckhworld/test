<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jquerymobile/1.4.2/jquery.mobile.min.css" />
<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />

<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">

<style>
  .TableTitle {
    width: 100%;
    border: 0;
    padding: 0;
    margin: 0;
    background: #213578;
    color: white;
  }
  .TableRow1 {
    width: 100%;
    border: 0;
    padding: 0px;
    margin: 0px;
    background: #91A2DC;
    color: black;
  }
  .TableRow2 {
    width: 100%;
    border: 0px;
    border-bottom: 1px solid rgb(230,230,230);
    padding: 0px;
    margin: 0px;
    background: #A5B2DC;
    color: black;
    overflow: hidden;
  }
  .PeopleListTable {
    width: 100%;
  }
  .PeopleListTable TD {
    border: 1px solid #91A2DC;
    padding: 5px;
    margin: 0px;
  }
  .TableRowStatus {
    height: 300px;
    color: blue;
    font-size: 200%;
  }
  .PeopleName {
    font-weight: bold;
    color: purple;
    cursor: pointer;
  }
  .ErrorBox {
    display: none;
    color: red;
  }
  .AmtNeg {
    color: red;
  }
  .AmtPos {
    color: blue;
  }
  .AmtBarBG {
    display: inline-block;
    height: 10px;
    width: 100px;
    border: 1px solid black;
    padding: 0px;
    margin: 0px;
  }
  .AmtBarNeg {
    top: 0; left: 0;
    display: block;    
    height: 10px;
    background-color: red;
    padding: 0px;
    margin: 0px;
  }
  .AmtBarPos {
    top: 0; left: 0;
    display: block;
    height: 10px;
    background-color: blue;
    padding: 0px;
    margin: 0px;
  }
  .TxnTable, .TxnTable TD {
    background: white;
    border: 1px solid #6578B8;
    margin: 0;
    padding: 0;
  }
  .PeopleListHeader TD {
    background: #91A2DC;
  }
  #DialogBox {
    background: #A5B2DC;
    border-top: 3px solid #91A2DC;
    border-left: 3px solid #91A2DC;
    border-bottom: 3px solid #213578;
    border-right: 3px solid #213578;
    border-radius:10px;
    padding: 20px;
    display: none;
    width: 600px;
    height: 400px;
    z-index: 100;
  }
  #DialogBox DIV {
    margin-left: auto;
    margin-right: auto;
  }
  .CloseButton {
    display: inline;
    color: blue;
    cursor: pointer;
  }
  .ImgToggleLink {
    color: blue;
    cursor: pointer;
  }
  .ImgToggleImg {
    display: none;
  }
  #LoadingBox {
    background: rgba(165,178,220,0.8); //A5B2DC
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0px;
    left: 0px;
    font-size: 300%;
    text-align: center;
    padding-top: 300px;
    color: black;
    z-index: 999;
  }

  @media (max-device-width: 1200px) {
    input, select {
      font-size: 30pt;
      height: 50pt;
      width: 100%;
      border-radius: 20px;
    }
    .TableRowStatus {
      height: 1000px;
      color: blue;
      font-size: 500%;
    }
  }

</style>

<div id="LoadingBox">Loading, please wait...</div>

<div id="DialogBox">
  <div id="DialogBoxHeader">[<div onclick="$('#DialogBox').hide()" class="CloseButton">Close</div>]</div>
  <div id="DialogBoxBody"></div>
  <div id="DialogBoxFooter"></div>
</div>

<form id="formInputTrans">
<div class="TableTitle">Input new transaction:</div>
<div class="TableRow2" id="WelcomeMessage">
  <ol>
    <li>If you <b>paid an event</b>, input <i>total amount</i> and <i>paid ratio/share ratio</i>.  <i>Amount</i> per person will be auto-calculated.</li>
    <li>Click to see some common scenarios:</li>
    <ul>
      <li>
        <div class="ImgToggleLink">Even Sharing Example</div>
        <div class="ImgToggleImg"><img src="https://drive.google.com/uc?export=download&id=0B-nwuDNAgpq6SmR1NEV0RHhwODQ"></div></li>
      <li>
        <div class="ImgToggleLink">Uneven Sharing Example</div>
        <div class="ImgToggleImg"><img src="https://drive.google.com/uc?export=download&id=0B-nwuDNAgpq6TGJjQTBrUVk5VDA"></div></li>
      <li>
        <div class="ImgToggleLink">Uneven Paying Example</div>
        <div class="ImgToggleImg"><img src="https://drive.google.com/uc?export=download&id=0B-nwuDNAgpq6UTdWOE1UdkVRWDA"></div></li>
    </ul>
    <li>If you have <b>settled your negative balance</b> to someone with positive balance, input the <i>total amount</i>, <i>you</i> "paid 1" and the <i>payee</i> "share 1".</li>
  </ol>
</div>

<div class="TableRow1">Date (YYYY-MM-DD):</div>
<div class="TableRow2">
  <input type="text" name="txnDate" id="txnDate" required placeholder="YYYY-MM-DD" />
  <span id="txnDateError" class="ErrorBox">Please input valid date.</span>
  </div>

<div class="TableRow1">Description:</div>
<div class="TableRow2"><input type="text" name="txnDesc" required placeholder="Description" /></div>

<div class="TableRow1">Total Amount(HK$):</div>
<div class="TableRow2">
  <input type="number" name="txnAmt" id="txnAmt" required min="0.1" max="99999" step="0.1" placeholder="Total amount" />
  <span id="txnAmtError" class="ErrorBox">Please input positive amount.</span>
  </div>

<div class="TableRow1">Paid/Share Ratios:<br/>
  (Input 1/2/3... to the ratio fields.  Amounts will be auto-calculated.  After that, you can adjust the amounts manually, if needed.)<br/>
  (To see <b>recent transaction list</b>, tap people name.)
  </div>
<div class="TableRow2"><input type="button" onclick="document.getElementById('PeopleList').innerHTML='Reloading...';google.script.run.withSuccessHandler(showPeopleList).getPeopleNames();" value="Reload people list" /></div>
<div id="PeopleList">
(Loading people list, please wait...)
</div>

<div class="TableRow1"><input type="submit" value="Submit" id="submitButton" disabled="yes"
     onclick="showStatus('Saving, please wait...');google.script.run.withSuccessHandler(showStatus).insertNewTransaction(this.form);return false;" />
  </div>
</form>

<div class="TableRow2 TableRowStatus" id="divResult"> </div>

<!-- *********************************************************************************** -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquerymobile/1.4.2/jquery.mobile.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>

<script>
"use strict";

window.debuglog=false;

// show status after form submit --------------------------------------------------------------------
  function showStatus(msg) {
    if (msg=='OK') {
      $("#divResult").html('Transaction saved successfully.');
      $("#formInputTrans")[0].reset();
      document.getElementById('submitButton').disabled=true;
      document.getElementById('PeopleList').innerHTML='Reloading...';
      google.script.run.withSuccessHandler(showPeopleList).getPeopleNames();
    } else {
      $("#divResult").html(msg);
    }
  }
  
// show people list for form input --------------------------------------------------------------------
  function showPeopleList(svrReply) {
    if (window.debuglog&&window.console) console.log("showPeopleList() start");

    var nameList = svrReply[0];
    var balanceList = svrReply[1];

    var minBalance = Math.min.apply(Math,balanceList);
    var maxBalance = Math.max.apply(Math,balanceList);

    var div = document.getElementById('PeopleList');
    var htmlValue='';
    
    if (window.debuglog&&window.console) console.log("showPeopleList() adding hidden PeopleList");
    htmlValue += '<input type="hidden" name="PeopleList" value="'+nameList+'" />';

    if (window.debuglog&&window.console) console.log("showPeopleList() adding each TableRow");
    var i;
    var AmtBarWidth=100;
    htmlValue+='<div class="TableRow2"><table class="PeopleListTable">'+
                   '<tr class="PeopleListHeader"><td></td>'+
                   '<td></td>'+
                   '<td>Paid per person</td>'+
                   '<td>Share per person</td>'+
                   '<td>Sum of amounts (should be balanced, i.e. 0)</td>'+
                   '</tr>'+
                   '<tr><td></td>'+
                   '<td></td>'+
                   '<td><span id="UnitAmtPaid">0</span></td>'+
                   '<td><span id="UnitAmtShare">0</span></td>'+
                   '<td><span id="BalanceAmt">0</span></td>'+
                   '</tr>'+
                   '<tr class="PeopleListHeader"><td>Name</td>'+
                   '<td>Balance</td>'+
                   '<td>Paid Ratio</td>'+
                   '<td>Share Ratio</td>'+
                   '<td>Amount</td>'+
                   '</tr>';
    for (i=0; i<nameList.length; i++) {
      if (window.debuglog&&window.console)console.log('Amt Bar width: '+i+': '+(isNaN(balanceList[i])?0:(balanceList[i]>0)?balanceList[i]/maxBalance*AmtBarWidth:balanceList[i]/minBalance*AmtBarWidth));
      htmlValue += '<tr><td><span class="PeopleName" name="'+nameList[i]+'">'+nameList[i]+'</span> '+
                       '<span class="Amt'+(!isNaN(balanceList[i])&&balanceList[i]>0?'Pos':'Neg')+'">HK$'+(isNaN(balanceList[i])?balanceList[i]:balanceList[i].toFixed(2))+'</span></td>'+
                       '<td><span class="AmtBarBG"><span class="AmtBar'+(!isNaN(balanceList[i])&&balanceList[i]>0?'Pos':'Neg')+'" style="width: '+(isNaN(balanceList[i])?0:(balanceList[i]>0)?balanceList[i]/maxBalance*AmtBarWidth:balanceList[i]/minBalance*AmtBarWidth)+'px;"></span></span></td>'+
                       '<td><input type="number" class="PaidRatio" name="P'+i+'" id="P'+i+'" size="10" min="0" max="100" step="1" placeholder="Paid:'+nameList[i]+'" /></td>'+
                       '<td><input type="number" class="ShareRatio" name="S'+i+'" id="S'+i+'" size="10" min="0" max="100" step="1" placeholder="Share:'+nameList[i]+'" /></td>'+
                       '<td><input type="text" class="AmountField" name="Amount'+i+'" id="Amount'+i+'" size="10" min="-99999" max="99999" step="0.01" placeholder="'+nameList[i]+' Amount" /></td>'+
                       '</tr>';
    }
    htmlValue+='</table></div>';
    
    div.innerHTML=htmlValue;
    
    // add event handler: on change of PaidRatio/ShareRatio field--------------------------------------------------
    $(".PaidRatio, .ShareRatio, #txnAmt").change(function(e){
      if(window.debuglog&&window.console)console.log('Field '+e.target.name+' changed');
      // re-calculate UnitAmtPaid, UnitAmtShare and AmountField based on PaidRatio and ShareRatio
      // Header Row:
      //   ID:     UnitAmtPaid / UnitAmtShare / BalanceAmt
      // People Rows:
      //   Class:  PaidRatio / ShareRatio / AmountField
      //   Name:   P<n> / S<n> / Amount<n>
      //   ID:     nil / nil / Amount<n>
      
      // validate numeric input 
      if (isNaN(e.target.value)) {
          if (window.debuglog&&window.console)console.log('Not numeric input: '+e.target.name+'='+e.target.value);
          $(e.target).css('background-color','red');
          document.getElementById('submitButton').disabled=true;
          return false;
      } else {
          $(e.target).css('background-color','');
          document.getElementById('submitButton').disabled=false;
      }
      // count Paid/Share Ratio
      var txnAmt = $("#txnAmt").val();
      var PaidRatioSum=0;
      $(".PaidRatio").each(function(){
        PaidRatioSum+=(isNaN(this.value))?0:+this.value;
      });
      var ShareRatioSum=0;
      $(".ShareRatio").each(function(){
        ShareRatioSum+=(isNaN(this.value))?0:+this.value;
      });
      // calc paid/share unit amount
      var unitPaid = (PaidRatioSum>0)?(txnAmt/PaidRatioSum).toFixed(2):0;
      var unitShare = (ShareRatioSum>0)?(txnAmt/ShareRatioSum).toFixed(2):0;
      $('#UnitAmtPaid').html(unitPaid);
      $('#UnitAmtShare').html(unitShare);
      
      // update balance amount
      updateBalanceAmt(true); // re-calc amount of each row
    });

    // add event handler: on change of AmountField field--------------------------------------------------
    $(".AmountField").change(function(e){
      // validate numeric input 
      if (isNaN(e.target.value)) {
          if (window.debuglog&&window.console)console.log('Not numeric input: '+e.target.name+'='+e.target.value);
          $(e.target).css('background-color','red');
          document.getElementById('submitButton').disabled=true;
      } else {
          $(e.target).css('background-color','');
          document.getElementById('submitButton').disabled=false;
      }

      // update balance amount
      updateBalanceAmt(false); // not re-calc amount of each row
    });

    function updateBalanceAmt(recalcRow) {
      // update amount of each person
      var unitPaid = +$('#UnitAmtPaid').html();
      var unitShare = +$('#UnitAmtShare').html();
      
      var BalanceSum=0;
      $(".AmountField").each(function(){
        if (recalcRow) { //TODO Bug: number spinbox is triggered twice by this code segment, debug for root cause.
          // update amount fields based on paid/share ratio
          //var PRatio = $('.PeopleListTable .PaidRatio[name='+this.name.replace('Amount','P')+']').val();
          //var SRatio = $('.PeopleListTable .ShareRatio[name='+this.name.replace('Amount','S')+']').val();
          var PRatio = $('#'+this.name.replace('Amount','P')).val(); // replace #Amount1,2,3... to #P1,2,3...
          var SRatio = $('#'+this.name.replace('Amount','S')).val(); // replace #Amount1,2,3... to #S1,2,3...
          PRatio = isNaN(PRatio)?0:PRatio;
          SRatio = isNaN(SRatio)?0:SRatio;
          if (window.debuglog&&window.console)console.log(this.name+':'+PRatio+','+SRatio);
          this.value = (PRatio * unitPaid - SRatio * unitShare).toFixed(2);
          if(this.value==0)this.value='';
        }
        // sum up the amount fields
        BalanceSum+=isNaN(this.value)?0:+this.value;
      });

      // update balance amount, show error if unbalance (total balance != 0)
      $("#BalanceAmt").html((+BalanceSum).toFixed(2));
      if (Math.abs((+BalanceSum).toFixed(2))>=0.01) {
        $("#BalanceAmt").css({background: "red", color: "yellow"});
        document.getElementById('submitButton').disabled=true;
      } else {
        $("#BalanceAmt").css({background: "", color: ""});
        document.getElementById('submitButton').disabled=false;
      }
    }

    // add event handler: show txn list dialog box after name being clicked
    $(".PeopleName").click(function(e) {
      if(window.debuglog&&window.console)console.log('Name clicked: '+$(this).text());
      $("#DialogBoxBody").html('<div style="background: white; height: 300px; width: 400px;">Loading transaction list...</div>');
      $("#DialogBox").center().show();
      google.script.run.withSuccessHandler(showTxnBox).getTxn($(this).text(),10,0);      
    });

    // enable form submit button
    document.getElementById('submitButton').disabled=false;
    
    if (window.debuglog&&window.console) console.log("showPeopleList() end");

  }


// update transaction list in dialog box ----------------------------------------------------------
  function showTxnBox(svrResult) {
    if(window.debuglog&&window.console)console.log('showTxnBox() start');
    var txnList='<table class="TxnTable">';

    var txnName=svrResult[0];
    var txnDate=svrResult[1];
    var txnDesc=svrResult[2];
    var txnAmt=svrResult[3];
    if(window.debuglog&&window.console)console.log('showTxnBox() svrResult='+txnDate+' / '+txnDesc+' / '+txnAmt);

    txnList+='<tr><td colspan="3">Recent Transactions of <b>'+txnName+'</b></td></tr>'+
             '<tr><td>Date</td><td>Description</td><td>Amount:</td></tr>';

    var i;
    for (i=0;i<txnDate.length;i++) {
      txnList+='<tr><td>'+txnDate[i]+'</td><td>'+txnDesc[i]+'</td><td>'+txnAmt[i].toFixed(2)+'</td></tr>';
    }

    txnList+='</table>';

    if(window.debuglog&&window.console)console.log('showTxnBox() show dialog');
    $("#DialogBoxBody").html(txnList);
  }

// trigger people list loading after page load ------------------------------------------------------------
  google.script.run.withSuccessHandler(showPeopleList).getPeopleNames();
  
// initial jQueryUI: date picker, dialog... etc. ------------------------------------------------------------
  $("#txnDate").datepicker({dateFormat:"yy-mm-dd"}); 
//  $("#DialogBox").dialog({ autoOpen: false, modal: true, minHeight: 500, minWidth: 600, position: {my: "top", at: "top", of: window} });
//  $("#DialogBox").dialog({ autoOpen: false, modal: true, minHeight: 500, minWidth: 600 });
//  $('.DialogBox').css({position:"fixed"});  // google app script not supporting position:fixed
//  $(".DialogBox").stop(function() {
//      $(".DialogBox").css({position:"fixed"});
//  });

// validate date input-------------------------------------------------------------------------------------
  $("#txnDate").change(function(e){ 
    var newDate=""; 
    try { 
      $("#txnDateError").hide();
      $(e.target).css('background-color','');
      document.getElementById('submitButton').disabled=false;
      newDate = $.datepicker.parseDate( "yy-mm-dd", e.target.value ); 
    } catch (err) { 
      if (window.debuglog&&window.console) console.log("datepicker parseDate error: "+err); 
      $("#txnDateError").show();
      $(e.target).css('background-color','red');
      document.getElementById('submitButton').disabled=true;
    } 
  }); 

// validate total amount input-------------------------------------------------------------------------------
  $("#txnAmt").change(function(e){
    $("#txnAmtError").hide();
    document.getElementById('submitButton').disabled=false;
    $(e.target).css('background-color','');
    if (isNaN(e.target.value) || e.target.value<=0) {
      $("#txnAmtError").show();
      $(e.target).css('background-color','red');
      document.getElementById('submitButton').disabled=true;
    }
  });

// stick DialogBox to same position while scrolling-----------------------------------------------------------
  $(document).scroll(function(e){
    $('#DialogBox').center();    
  });

  jQuery.fn.center = function () {
    this.css("position","absolute");
    this.css("top", Math.max(0, ((800 - $(this).outerHeight()) / 2) + 
                                                $(window).scrollTop()) + "px");
    this.css("left", Math.max(0, (($(document).width() - $(this).outerWidth()) / 2) + 
                                                $(window).scrollLeft()) + "px");
    return this;
}

// Toggle display of ImgToggleImg by clicking ImgToggleLink (In #WelcomeMessage)
  $("#WelcomeMessage .ImgToggleLink").click(function(evt){
    $("#WelcomeMessage .ImgToggleImg").each(function(){ // hide all images first
      $(this).hide();
    });
    $(evt.target).parent().find(".ImgToggleImg").show(); // show the selected image
  });
  
  $(function(){
    $('#LoadingBox').hide();
  });
</script>

